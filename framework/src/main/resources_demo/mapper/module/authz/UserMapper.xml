<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.liwen.go.module.authz.mapper.UserMapper">

	<insert id="createUser" parameterType="User" useGeneratedKeys="true"
		keyProperty="id">
		insert into
		sys_users(username, password, salt,
		locked)
		values(#{username},#{password},#{salt}, #{locked})
	</insert>

	<update id="updateUser" parameterType="User">
		update sys_users set
		username=#{username}, password=#{password}, salt=#{salt},
		locked=#{locked} where id=#{id}
	</update>

	<delete id="deleteUser" parameterType="long">
		delete from sys_users
		where id=#{userId}
	</delete>

	<insert id="correlationRoles" parameterType="map">
		insert into sys_users_roles(user_id, role_id) values
		<foreach collection="roleIds" item="roleId" separator=",">
			(#{userId}, #{roleId})
		</foreach>
	</insert>
	<delete id="uncorrelationRoles" parameterType="map">
		delete from sys_users_roles where user_id=#{userId} and role_id in
		<foreach collection="roleIds" item="roleId" separator="," open="("
			close=")">
			#{roleId}
		</foreach>
	</delete>
	<select id="exists" parameterType="map" resultType="boolean">
		select
		count(1)=1 from sys_users_roles where user_id=#{userId} and
		role_id=#{roleId}
	</select>

	<select id="findOne" parameterType="long" resultType="User">
		select id,
		username, password, salt, locked from sys_users where id=#{userId}
	</select>

	<select id="findByUsername" parameterType="string" resultType="User">
		select id, username, password, salt, locked from sys_users where
		username=#{username}
	</select>

	<select id="findRoles" parameterType="string" resultType="string">
		select
		role from sys_users u,
		sys_roles
		r,sys_users_roles ur where
		u.username=#{username} and
		u.id=ur.user_id and
		r.id=ur.role_id
	</select>

	<select id="findPermissions" parameterType="string" resultType="string">
		select permission from sys_users u, sys_roles r, sys_permissions p,
		sys_users_roles ur, sys_roles_permissions rp where
		u.username=#{username} and
		u.id=ur.user_id and r.id=ur.role_id and
		r.id=rp.role_id and
		p.id=rp.permission_id
	</select>
</mapper>